# 第5章：ソフト制御との連携設計（RISC-V上でのAITL連携）

## 🎯 本章の目的

PoCの動作を完全に制御するためには、FSMやPIDを含むハードウェア制御に加え、ソフトウェア側からの連携が必要です。本章では、RISC-Vマイコンを用いたAITL構造との連携設計について述べます。

---

## 🧠 AITL構造とソフト連携の関係性

| AITL層     | ソフト制御の役割                          |
|------------|--------------------------------------------|
| 本能（FSM） | FSM状態の初期化・状態遷移トリガの発行       |
| 理性（PID） | ゲイン設定、目標値変更などのパラメータ制御   |
| 知性（LLM） | 対話内容や環境判断に応じた高次命令の送信     |

---

## 🖥️ RISC-Vを用いた構成例（最小構成）

| 機能ブロック     | 内容                                   |
|------------------|----------------------------------------|
| `main_loop.c`     | 状態監視・シリアル通信の中核             |
| `fsm_driver.c`    | 状態切替命令の発行、FSM応答ログの解釈     |
| `pid_config.c`    | PIDパラメータの設定                     |
| `llm_input.c`     | LLMや外部コマンドによる行動指示の受信     |

---

## 🔗 FSMブロックとの通信仕様

| 通信方向  | 通信内容             | 方式             |
|-----------|----------------------|------------------|
| RISC-V → FSM | 状態遷移トリガ         | UART（1バイト命令） |
| FSM → RISC-V | 現在状態通知           | UART（状態ID）      |

UART通信プロトコルの例：

```text
[0xA1] → start_walking
[0xB3] ← state = moving
```

## ⚙️ PIDブロックとの連携仕様

- ソフト側からゲインパラメータ（Kp, Ki, Kd）を設定  
- FSMから出力される制御信号に応じて設定更新可能  

```c
set_pid_gains(Kp = 1.2, Ki = 0.05, Kd = 0.1);
```

## 💡 LLM制御とのインタフェース（上位連携）

LLM判断結果や外部クラウドから、以下のような高次命令をRISC-Vへ送信：

| 指令名         | 内容                             |
|----------------|----------------------------------|
| `approach_user` | FSMへ接近状態へ遷移命令             |
| `stop_motion`   | FSMへ停止状態へ遷移命令             |
| `set_mode_1`    | PIDゲインを指定プリセットに設定       |

LLMは高次層の「知性」として、RISC-Vを通じてFSMやPIDを操作します。これにより、以下が可能となります：

- 対話内容や状況判断に応じた行動切替
- 環境変化に応じたゲイン自動調整
- 共感的ふるまいの指令伝達（例：ゆっくり話す、近づかない）

---

## 🧪 評価とデバッグの観点

- FSM状態ログをRISC-V経由でモニタリング可能にする  
- パラメータのリアルタイム変更と効果の観測  
- コマンド受信処理とFSM応答の整合性確認

---

## 📦 想定フォルダ構成例（firmware側）

```text
firmware/
├── main_loop.c
├── fsm_driver.c
├── pid_config.c
├── llm_input.c
├── uart_if.c
└── Makefile
```

## 📬 連絡先

執筆・設計：**三溝 真一（Shinichi Samizo）**  
GitHub: [https://github.com/Samizo-AITL](https://github.com/Samizo-AITL)  
Email: shin3t72@gmail.com

---

